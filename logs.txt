michomanoly14892@raspberrypi:~/EZREC-BACKEND-2 $ sudo ./deployment.sh 
[21:25:13] Starting EZREC deployment as user: root
[21:25:13] STEP: 1. Applying comprehensive system fixes
[21:25:13] ğŸ”§ Fixing port conflicts with comprehensive cleanup...
[21:25:13] ğŸ§¹ Performing comprehensive system cleanup...
[21:25:13] ğŸ›‘ Stopping all EZREC services...
[21:25:14] ğŸ“· Killing all camera-related processes...
[21:25:14] ğŸ Killing Python camera processes...
[21:25:14] ğŸ”“ Clearing camera device locks...
[21:25:15] ğŸ—‘ï¸ Clearing booking cache...
[21:25:15] ğŸ—‘ï¸ Clearing temporary recording files...
[21:25:15] ğŸ”„ Resetting camera devices...
[21:25:18] âœ… Comprehensive system cleanup completed
[21:25:18] ğŸ§¹ Comprehensive port cleanup...
[21:25:18] ğŸ§¹ Killing processes by name...
[21:25:18] ğŸ§¹ Killing any remaining Python service processes...
[21:25:20] ğŸ§¹ Force killing any remaining processes on ports 8000 and 9000...
[21:25:23] âœ… Port 8000 is now free
[21:25:23] âœ… Port 9000 is now free
[21:25:23] âœ… Comprehensive port conflict resolution completed
[21:25:23] ğŸ—‘ï¸ Clearing old recordings and temporary files...
[21:25:23] ğŸ—‘ï¸ Clearing temporary files...
[21:25:23] ğŸ—‘ï¸ Clearing old log files...
[21:25:23] ğŸ—‘ï¸ Clearing old systemd journal logs...
[21:25:23] âœ… Old recordings and temporary files cleared
[21:25:23] ğŸ“‹ Initializing fresh booking cache...
[21:25:23] âœ… Fresh booking cache initialized
[21:25:23] ğŸ”§ Installing psutil in all virtual environments...
[21:25:23] ğŸ“¦ Installing psutil in backend virtual environment...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: psutil in /home/michomanoly14892/.local/lib/python3.11/site-packages (5.9.5)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:25] âœ… psutil installed successfully in backend venv
[21:25:25] ğŸ“¦ Installing psutil in API virtual environment...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: psutil in /home/michomanoly14892/.local/lib/python3.11/site-packages (5.9.5)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:27] âœ… psutil installed successfully in API venv
[21:25:27] ğŸ§ª Testing psutil imports...
âœ… psutil imported successfully in backend
[21:25:27] âœ… psutil import test passed in backend
âœ… psutil imported successfully in API
[21:25:27] âœ… psutil import test passed in API
[21:25:27] âœ… psutil installed and tested successfully in all environments
[21:25:27] ğŸ“ Copying all project files to deployment directory...
[21:25:27] ğŸ“„ Copying backend files...
[21:25:27] âœ… Backend files copied successfully
[21:25:27] ğŸ“„ Copying API files...
[21:25:27] âœ… API files copied successfully
[21:25:27] ğŸ“„ Copying systemd service files...
[21:25:27] âœ… Systemd service files copied and reloaded
[21:25:27] ğŸ“„ Copying updated system_status.py...
[21:25:27] âœ… system_status.py updated successfully
[21:25:27] ğŸ“„ Copying services directory...
[21:25:27] âœ… Services directory copied successfully
[21:25:27] ğŸ“„ Copying config directory...
[21:25:27] âœ… Config directory copied successfully
[21:25:27] ğŸ“„ Copying utils directory...
[21:25:27] âœ… Utils directory copied successfully
[21:25:27] ğŸ”’ Existing .env file found in deployment directory - preserving it
[21:25:27] â„¹ï¸ To update .env, manually edit: /opt/ezrec-backend/.env
[21:25:27] âœ… All project files copied successfully
[21:25:27] ğŸ”§ Installing new architecture dependencies...
[21:25:27] ğŸ“¦ Installing new architecture dependencies in backend virtual environment...
[21:25:27] ğŸ“¦ Installing pytz...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: pytz in /usr/lib/python3/dist-packages (2022.7.1)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:29] âœ… pytz installed successfully
[21:25:29] ğŸ“¦ Installing python-dotenv...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: python-dotenv in /home/michomanoly14892/.local/lib/python3.11/site-packages (1.0.0)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:31] âœ… python-dotenv installed successfully
[21:25:31] ğŸ“¦ Installing supabase...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: supabase in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (2.0.2)
Requirement already satisfied: gotrue<2.0.0,>=1.3.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (1.3.1)
Requirement already satisfied: httpx<0.25.0,>=0.24.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (0.24.1)
Requirement already satisfied: postgrest<0.14.0,>=0.10.8 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (0.13.2)
Requirement already satisfied: realtime<2.0.0,>=1.0.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (1.0.6)
Requirement already satisfied: storage3<0.7.0,>=0.5.3 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (0.6.1)
Requirement already satisfied: supafunc<0.4.0,>=0.3.1 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from supabase) (0.3.3)
Requirement already satisfied: pydantic<3,>=1.10 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from gotrue<2.0.0,>=1.3.0->supabase) (2.11.7)
Requirement already satisfied: certifi in /home/michomanoly14892/.local/lib/python3.11/site-packages (from httpx<0.25.0,>=0.24.0->supabase) (2025.6.15)
Requirement already satisfied: httpcore<0.18.0,>=0.15.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from httpx<0.25.0,>=0.24.0->supabase) (0.17.3)
Requirement already satisfied: idna in /home/michomanoly14892/.local/lib/python3.11/site-packages (from httpx<0.25.0,>=0.24.0->supabase) (3.10)
Requirement already satisfied: sniffio in /home/michomanoly14892/.local/lib/python3.11/site-packages (from httpx<0.25.0,>=0.24.0->supabase) (1.3.1)
Requirement already satisfied: h11<0.15,>=0.13 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from httpcore<0.18.0,>=0.15.0->httpx<0.25.0,>=0.24.0->supabase) (0.14.0)
Requirement already satisfied: anyio<5.0,>=3.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from httpcore<0.18.0,>=0.15.0->httpx<0.25.0,>=0.24.0->supabase) (3.7.1)
Requirement already satisfied: deprecation<3.0.0,>=2.1.0 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from postgrest<0.14.0,>=0.10.8->supabase) (2.1.0)
Requirement already satisfied: strenum<0.5.0,>=0.4.9 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from postgrest<0.14.0,>=0.10.8->supabase) (0.4.15)
Requirement already satisfied: packaging in /home/michomanoly14892/.local/lib/python3.11/site-packages (from deprecation<3.0.0,>=2.1.0->postgrest<0.14.0,>=0.10.8->supabase) (25.0)
Requirement already satisfied: annotated-types>=0.6.0 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue<2.0.0,>=1.3.0->supabase) (0.7.0)
Requirement already satisfied: pydantic-core==2.33.2 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue<2.0.0,>=1.3.0->supabase) (2.33.2)
Requirement already satisfied: typing-extensions>=4.12.2 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue<2.0.0,>=1.3.0->supabase) (4.15.0)
Requirement already satisfied: typing-inspection>=0.4.0 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue<2.0.0,>=1.3.0->supabase) (0.4.1)
Requirement already satisfied: python-dateutil<3.0.0,>=2.8.1 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from realtime<2.0.0,>=1.0.0->supabase) (2.9.0.post0)
Requirement already satisfied: websockets<13,>=11 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from realtime<2.0.0,>=1.0.0->supabase) (12.0)
Requirement already satisfied: six>=1.5 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from python-dateutil<3.0.0,>=2.8.1->realtime<2.0.0,>=1.0.0->supabase) (1.17.0)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:32] âœ… supabase installed successfully
[21:25:32] ğŸ“¦ Installing boto3...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Requirement already satisfied: boto3 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (1.34.0)
Requirement already satisfied: botocore<1.35.0,>=1.34.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from boto3) (1.34.162)
Requirement already satisfied: jmespath<2.0.0,>=0.7.1 in /usr/lib/python3/dist-packages (from boto3) (1.0.1)
Requirement already satisfied: s3transfer<0.10.0,>=0.9.0 in /opt/ezrec-backend/backend/venv/lib/python3.11/site-packages (from boto3) (0.9.0)
Requirement already satisfied: python-dateutil<3.0.0,>=2.1 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from botocore<1.35.0,>=1.34.0->boto3) (2.9.0.post0)
Requirement already satisfied: urllib3!=2.2.0,<3,>=1.25.4 in /usr/lib/python3/dist-packages (from botocore<1.35.0,>=1.34.0->boto3) (1.26.12)
Requirement already satisfied: six>=1.5 in /home/michomanoly14892/.local/lib/python3.11/site-packages (from python-dateutil<3.0.0,>=2.1->botocore<1.35.0,>=1.34.0->boto3) (1.17.0)
WARNING: Error parsing dependencies of send2trash: Expected matching RIGHT_PARENTHESIS for LEFT_PARENTHESIS, after version specifier
    sys-platform (=="darwin") ; extra == 'objc'
                 ~^
[21:25:34] âœ… boto3 installed successfully
[21:25:34] âœ… New architecture dependencies installation completed
[21:25:34] ğŸ§ª Testing new architecture imports...
âœ… Config settings import successful
[21:25:34] âœ… New architecture imports test passed
[21:25:34] ğŸ”§ Creating fallback dual_recorder for compatibility...
[21:25:34] âœ… Fallback dual_recorder created
[21:25:34] ğŸ”§ Fixing camera initialization issues...
[21:25:34] ğŸ“· Checking camera accessibility...
[21:25:34] ğŸ” Ensuring camera permissions...
[21:25:34] âœ… Camera device /dev/video0 found
[21:25:34] âœ… Camera device /dev/video1 found
[21:25:34] âœ… Camera initialization fixes applied
[21:25:34] ğŸ”§ Ensuring dual_recorder.py is correct and executable...
[21:25:34] ğŸ“„ Force copying dual_recorder.py from source...
[21:25:34] âœ… dual_recorder.py copied and made executable
[21:25:34] WARNING: âš ï¸ WARNING: File may not be the correct version
[21:25:34] âœ… Dual recorder setup completed
[21:25:34] ğŸ§ª Testing dual_recorder functionality...
âœ… New architecture imports successful
[21:25:35] âœ… New architecture dual_recorder should work
[21:25:35] ğŸ”„ Force restarting dual_recorder service...
[21:25:40] WARNING: âš ï¸ dual_recorder service may not have started properly
[21:25:40] ğŸ”§ Ensuring all required files and directories exist...
[21:25:40] ğŸ“ Creating logs directory...
[21:25:40] âœ… Logs directory created with proper permissions
[21:25:40] ğŸ“„ Creating system_status.log file...
[21:25:40] âœ… system_status.log file created with proper permissions
[21:25:40] ğŸ“„ Copying system_status.py to deployment directory...
[21:25:40] âœ… system_status.py copied with proper permissions
[21:25:40] ğŸ“„ Creating all required log files...
[21:25:40] âœ… Fixed permissions for existing video_worker.log
[21:25:40] âœ… Fixed permissions for existing dual_recorder.log
[21:25:40] âœ… Fixed permissions for existing api_server.log
[21:25:40] âœ… Fixed permissions for existing health_check.log
[21:25:40] âœ… Fixed permissions for existing service_monitor.log
[21:25:40] âœ… All required files and directories created with proper permissions
[21:25:40] ğŸ”§ Handling service restart issues...
[21:25:40] ğŸ›‘ Stopping all services to break restart loops...
[21:25:45] ğŸ§¹ Killing any remaining service processes...
[21:25:48] âœ… Service restart issues handled
[21:25:48] ğŸ”§ Ensuring all services are properly enabled...
[21:25:48] ğŸ”§ Enabling dual_recorder.service for auto-start...
[21:25:48] âœ… dual_recorder.service enabled successfully
[21:25:48] ğŸ”§ Enabling video_worker.service for auto-start...
[21:25:49] âœ… video_worker.service enabled successfully
[21:25:49] ğŸ”§ Enabling ezrec-api.service for auto-start...
[21:25:49] âœ… ezrec-api.service enabled successfully
[21:25:49] ğŸ”§ Enabling system_status.service for auto-start...
[21:25:49] âœ… system_status.service enabled successfully
[21:25:49] ğŸ”§ Enabling system_status.timer for auto-start...
[21:25:49] âœ… system_status.timer enabled successfully
[21:25:49] ğŸ” Verifying services are enabled...
[21:25:49] âœ… dual_recorder.service is enabled
[21:25:49] âœ… video_worker.service is enabled
[21:25:49] âœ… ezrec-api.service is enabled
[21:25:49] âœ… system_status.service is enabled
[21:25:49] âœ… All services properly enabled for auto-start
[21:25:49] STEP: 2. Starting all services safely
[21:25:49] ğŸ”§ Starting all services safely with port conflict prevention...
[21:25:49] ğŸ”§ Fixing port conflicts with comprehensive cleanup...
[21:25:49] ğŸ§¹ Performing comprehensive system cleanup...
[21:25:49] ğŸ›‘ Stopping all EZREC services...
[21:25:49] ğŸ“· Killing all camera-related processes...
[21:25:49] ğŸ Killing Python camera processes...
[21:25:49] ğŸ”“ Clearing camera device locks...
[21:25:50] ğŸ—‘ï¸ Clearing booking cache...
[21:25:50] ğŸ—‘ï¸ Removing booking cache: /opt/ezrec-backend/backend/bookings.json
[21:25:50] ğŸ—‘ï¸ Clearing temporary recording files...
[21:25:50] ğŸ”„ Resetting camera devices...
[21:25:53] âœ… Comprehensive system cleanup completed
[21:25:53] ğŸ§¹ Comprehensive port cleanup...
[21:25:53] ğŸ§¹ Killing processes by name...
[21:25:53] ğŸ§¹ Killing any remaining Python service processes...
[21:25:56] ğŸ§¹ Force killing any remaining processes on ports 8000 and 9000...
[21:25:59] âœ… Port 8000 is now free
[21:25:59] âœ… Port 9000 is now free
[21:25:59] âœ… Comprehensive port conflict resolution completed
[21:25:59] ğŸš€ Starting ezrec-api.service...
[21:25:59] ğŸ”§ Special handling for API service...
[21:25:59] âœ… ezrec-api.service started successfully
[21:25:59] â³ Waiting for API service to be ready...
Sep 14 21:25:59 raspberrypi systemd[1]: Started ezrec-api.service - EZREC FastAPI Backend.
Sep 14 21:26:00 raspberrypi uvicorn[604348]: 2025-09-14 21:26:00,018 [INFO] âœ… Supabase client initialized successfully
Sep 14 21:26:00 raspberrypi uvicorn[604348]: 2025-09-14 21:26:00,018 [INFO] âœ… Using camera ID: d217e751-dfa5-5276-abbb-da5ad6c2626a
Sep 14 21:26:00 raspberrypi uvicorn[604348]: INFO:     Started server process [604348]
Sep 14 21:26:00 raspberrypi uvicorn[604348]: INFO:     Waiting for application startup.
Sep 14 21:26:00 raspberrypi uvicorn[604348]: INFO:     Application startup complete.
Sep 14 21:26:00 raspberrypi uvicorn[604348]: INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
[21:26:09] âœ… API service is responding
Sep 14 21:26:09 raspberrypi uvicorn[604348]: INFO:     127.0.0.1:45978 - "GET /test-alive HTTP/1.1" 200 OK
[21:26:12] ğŸš€ Starting dual_recorder.service...
[21:26:12] âœ… dual_recorder.service started successfully
[21:26:12] â³ Waiting longer for dual_recorder to fully initialize...
[21:26:22] ğŸš€ Starting video_worker.service...
[21:26:22] âœ… video_worker.service started successfully
[21:26:22] â³ Waiting longer for video_worker to fully initialize...
[21:26:32] ğŸš€ Starting system_status.service...
[21:26:32] ğŸ”§ Special handling for system_status service...
[21:26:32] âœ… system_status.log file exists and is writable
[21:26:34] âœ… system_status.service started successfully
[21:26:37] ğŸš€ Starting system_status.timer...
[21:26:37] âœ… system_status.timer started successfully
[21:26:37] âœ… All services started safely
[21:26:37] â³ Waiting for all services to fully initialize...
[21:26:52] STEP: 3. Verifying system completely
[21:26:52] ğŸ” Performing comprehensive system verification...
[21:26:52] ğŸ§ª Checking all services are running...
[21:26:52] â³ dual_recorder.service not ready yet, retrying in 5s... (attempt 1/3)
[21:26:57] â³ dual_recorder.service not ready yet, retrying in 5s... (attempt 2/3)
[21:27:02] ERROR: âŒ dual_recorder.service is not running after 3 attempts
[21:27:02] ğŸ“‹ Service status:
â— dual_recorder.service - EZREC Dual Camera Recorder Service
     Loaded: loaded (/etc/systemd/system/dual_recorder.service; enabled; preset: enabled)
     Active: activating (auto-restart) since Sun 2025-09-14 21:26:59 EDT; 3s ago
    Process: 604481 ExecStart=/opt/ezrec-backend/backend/venv/bin/python3 /opt/ezrec-backend/backend/dual_recorder.py (code=exited, status=0/SUCCESS)
   Main PID: 604481 (code=exited, status=0/SUCCESS)
        CPU: 123ms
[1]-  Terminated              sudo journalctl -u dual_recorder.service -f
michomanoly14892@raspberrypi:~/EZREC-BACKEND-2 $ 