michomanoly14892@raspberrypi:~/EZREC-BACKEND-2 $ # Create a new booking that starts NOW and lasts 10 minutes
python3 -c "
import json
import time
from datetime import datetime, timedelta
import pytz

# Calculate booking times (start now, end in 10 minutes)
now = datetime.now(pytz.timezone('America/New_York'))
start_time = now
end_time = now + timedelta(minutes=10)

# Create test booking
test_booking = {
    'id': f'test-booking-{int(time.time())}',
    'user_id': 'test-user-123',
    'start_time': start_time.isoformat(),
    'end_time': end_time.isoformat(),
    'date': now.strftime('%Y-%m-%d'),
    'camera_id': 'test-camera-456',
    'recording_id': f'rec-{int(time.time())}',
    'status': None,
    'email': None,
    'created_at': now.isoformat(),
    'updated_at': now.isoformat()
}

# Save booking
with open('/opt/ezrec-backend/api/local_data/bookings.json', 'w') as f:
    json.dump([test_booking], f, indent=2)

print(f'✅ New booking created:')
print(f'   ID: {test_booking[\"id\"]}')
print(f'   Start: {start_time}')
print(f'   End: {end_time}')
print(f'   Duration: 10 minutes')
"

# Create the FINAL working recorder using rpicam-vid
sudo tee /opt/ezrec-backend/backend/dual_recorder.py > /dev/null << 'EOF'
#!/usr/bin/env python3
"""
FINAL WORKING RECORDER - Uses rpicam-vid which is available on your system
"""

import os
import sys
import time
import logging
import subprocess
from pathlib import Path
from datetime import datetime
import pytz

# Configuration
RECORDINGS_DIR = Path("/opt/ezrec-backend/recordings")
BOOKINGS_FILE = Path("/opt/ezrec-backend/api/local_data/bookings.json")

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class FinalWorkingRecorder:
    def __init__(self):
        self.recording = False
        self.recording_processes = {}
        
    def detect_cameras(self):
        """Detect available cameras using rpicam-vid"""
        available_cameras = []
        
        for index in range(2):
            try:
                # Test camera using rpicam-vid
                result = subprocess.run([
                    'rpicam-vid', 
                    '--camera', str(index),
                    '--timeout', '1000',
                    '--output', '/dev/null'
                ], capture_output=True, timeout=3)
                
sudo journalctl -u dual_recorder.service -fel_recorder.pyg recording")e_booking['id']}"))0'))
✅ New booking created:
   ID: test-booking-1757891292
   Start: 2025-09-14 19:08:12.450529-04:00
   End: 2025-09-14 19:18:12.450529-04:00
   Duration: 10 minutes
Sep 14 19:07:58 raspberrypi python3[584223]: 2025-09-14 19:07:58,872 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:07:58.872409-04:00
Sep 14 19:07:58 raspberrypi python3[584223]: 2025-09-14 19:07:58,872 - INFO - 🔍 Booking test-booking-1757890887: 2025-09-14 19:01:27.342005-04:00 - 2025-09-14 19:06:27.342005-04:00
Sep 14 19:07:58 raspberrypi python3[584223]: 2025-09-14 19:07:58,872 - INFO -    Now: 2025-09-14 19:07:58.872409-04:00
Sep 14 19:07:58 raspberrypi python3[584223]: 2025-09-14 19:07:58,872 - INFO - ❌ No active booking found
Sep 14 19:08:03 raspberrypi python3[584223]: 2025-09-14 19:08:03,872 - INFO - 📋 Loaded 0 bookings from cache
Sep 14 19:08:08 raspberrypi python3[584223]: 2025-09-14 19:08:08,873 - INFO - 📋 Loaded 0 bookings from cache
Sep 14 19:08:12 raspberrypi systemd[1]: Stopping dual_recorder.service - EZREC Dual Camera Recorder Service...
Sep 14 19:08:12 raspberrypi systemd[1]: dual_recorder.service: Deactivated successfully.
Sep 14 19:08:12 raspberrypi systemd[1]: Stopped dual_recorder.service - EZREC Dual Camera Recorder Service.
Sep 14 19:08:12 raspberrypi systemd[1]: Started dual_recorder.service - EZREC Dual Camera Recorder Service.
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,572 - INFO - 🎥 FINAL WORKING Dual Recorder Service Starting
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,574 - INFO - 📋 Loaded 1 bookings from cache
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:08:12.575230-04:00
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🔍 Booking test-booking-1757891292: 2025-09-14 19:08:12.450529-04:00 - 2025-09-14 19:18:12.450529-04:00
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO -    Now: 2025-09-14 19:08:12.575230-04:00
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🎯 Active booking found: test-booking-1757891292
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🎬 Starting recording for booking: test-booking-1757891292
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🎬 Starting recording session for booking: test-booking-1757891292
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,575 - INFO - 🔍 Detecting cameras...
Sep 14 19:08:12 raspberrypi python3[584329]: 2025-09-14 19:08:12,948 - WARNING - ⚠️ Camera 0 not available
Sep 14 19:08:13 raspberrypi python3[584329]: 2025-09-14 19:08:13,189 - WARNING - ⚠️ Camera 1 not available
Sep 14 19:08:13 raspberrypi python3[584329]: 2025-09-14 19:08:13,190 - INFO - 📷 Available cameras: []
Sep 14 19:08:13 raspberrypi python3[584329]: 2025-09-14 19:08:13,190 - ERROR - ❌ No cameras available
Sep 14 19:08:13 raspberrypi python3[584329]: 2025-09-14 19:08:13,190 - ERROR - ❌ Failed to start recording
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 📋 Loaded 1 bookings from cache
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:08:18.190465-04:00
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🔍 Booking test-booking-1757891292: 2025-09-14 19:08:12.450529-04:00 - 2025-09-14 19:18:12.450529-04:00
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO -    Now: 2025-09-14 19:08:18.190465-04:00
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🎯 Active booking found: test-booking-1757891292
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🎬 Starting recording for booking: test-booking-1757891292
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🎬 Starting recording session for booking: test-booking-1757891292
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,190 - INFO - 🔍 Detecting cameras...
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,429 - WARNING - ⚠️ Camera 0 not available
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,667 - WARNING - ⚠️ Camera 1 not available
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,667 - INFO - 📷 Available cameras: []
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,668 - ERROR - ❌ No cameras available
Sep 14 19:08:18 raspberrypi python3[584329]: 2025-09-14 19:08:18,668 - ERROR - ❌ Failed to start recording
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 📋 Loaded 1 bookings from cache
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:08:23.668372-04:00
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🔍 Booking test-booking-1757891292: 2025-09-14 19:08:12.450529-04:00 - 2025-09-14 19:18:12.450529-04:00
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO -    Now: 2025-09-14 19:08:23.668372-04:00
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🎯 Active booking found: test-booking-1757891292
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🎬 Starting recording for booking: test-booking-1757891292
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🎬 Starting recording session for booking: test-booking-1757891292
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,668 - INFO - 🔍 Detecting cameras...
Sep 14 19:08:23 raspberrypi python3[584329]: 2025-09-14 19:08:23,909 - WARNING - ⚠️ Camera 0 not available
Sep 14 19:08:24 raspberrypi python3[584329]: 2025-09-14 19:08:24,149 - WARNING - ⚠️ Camera 1 not available
Sep 14 19:08:24 raspberrypi python3[584329]: 2025-09-14 19:08:24,149 - INFO - 📷 Available cameras: []
Sep 14 19:08:24 raspberrypi python3[584329]: 2025-09-14 19:08:24,149 - ERROR - ❌ No cameras available
Sep 14 19:08:24 raspberrypi python3[584329]: 2025-09-14 19:08:24,149 - ERROR - ❌ Failed to start recording
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 📋 Loaded 1 bookings from cache
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:08:29.149643-04:00
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🔍 Booking test-booking-1757891292: 2025-09-14 19:08:12.450529-04:00 - 2025-09-14 19:18:12.450529-04:00
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO -    Now: 2025-09-14 19:08:29.149643-04:00
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🎯 Active booking found: test-booking-1757891292
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🎬 Starting recording for booking: test-booking-1757891292
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🎬 Starting recording session for booking: test-booking-1757891292
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,149 - INFO - 🔍 Detecting cameras...
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,418 - WARNING - ⚠️ Camera 0 not available
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,697 - WARNING - ⚠️ Camera 1 not available
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,697 - INFO - 📷 Available cameras: []
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,697 - ERROR - ❌ No cameras available
Sep 14 19:08:29 raspberrypi python3[584329]: 2025-09-14 19:08:29,697 - ERROR - ❌ Failed to start recording
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 📋 Loaded 1 bookings from cache
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🔍 Checking 1 bookings at 2025-09-14 19:08:34.698264-04:00
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🔍 Booking test-booking-1757891292: 2025-09-14 19:08:12.450529-04:00 - 2025-09-14 19:18:12.450529-04:00
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO -    Now: 2025-09-14 19:08:34.698264-04:00
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🎯 Active booking found: test-booking-1757891292
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🎬 Starting recording for booking: test-booking-1757891292
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🎬 Starting recording session for booking: test-booking-1757891292
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,698 - INFO - 🔍 Detecting cameras...
Sep 14 19:08:34 raspberrypi python3[584329]: 2025-09-14 19:08:34,972 - WARNING - ⚠️ Camera 0 not available
Sep 14 19:08:35 raspberrypi python3[584329]: 2025-09-14 19:08:35,232 - WARNING - ⚠️ Camera 1 not available
Sep 14 19:08:35 raspberrypi python3[584329]: 2025-09-14 19:08:35,233 - INFO - 📷 Available cameras: []
Sep 14 19:08:35 raspberrypi python3[584329]: 2025-09-14 19:08:35,233 - ERROR - ❌ No cameras available
Sep 14 19:08:35 raspberrypi python3[584329]: 2025-09-14 19:08:35,233 - ERROR - ❌ Failed to start recording
