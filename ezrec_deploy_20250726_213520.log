ğŸš€ EZREC Backend Deployment Script
==================================
ğŸ›‘ Stopping all existing services...
ğŸ”ª Killing remaining processes...
ğŸ§¹ Cleaning up old installation...
ğŸ“ Copying project files...
ğŸ”§ Checking and installing required tools...
âœ… FFmpeg is available
âœ… FFprobe is available
âœ… v4l2-ctl is available
âœ… Picamera2 is available
ğŸ“¦ Installing additional dependencies...
Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:3 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Hit:4 http://archive.raspberrypi.com/debian bookworm InRelease
Fetched 103 kB in 0s (219 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
python3-requests is already the newest version (2.28.1+dfsg-1).
python3-psutil is already the newest version (5.9.4-1+b1).
python3-boto3 is already the newest version (1.26.27+dfsg-1).
python3-dotenv is already the newest version (0.21.0-1).
build-essential is already the newest version (12.9).
0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
Reading package lists...
Building dependency tree...
Reading state information...
0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
ğŸ“ Creating required directories...
ğŸ Fixing Python path issues...
ğŸ Setting up Python virtual environment...
ğŸ“¦ Creating new virtual environment...
ğŸ” Setting virtual environment ownership to user: michomanoly14892
ğŸ” Fixing virtual environment ownership...
ğŸ“¦ Installing Python dependencies...
ğŸ”§ Installing Python packages...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Collecting fastapi
  Using cached fastapi-0.116.1-py3-none-any.whl (95 kB)
Collecting uvicorn
  Using cached uvicorn-0.35.0-py3-none-any.whl (66 kB)
Collecting python-multipart
  Using cached https://www.piwheels.org/simple/python-multipart/python_multipart-0.0.20-py3-none-any.whl (24 kB)
Collecting jinja2
  Using cached https://www.piwheels.org/simple/jinja2/jinja2-3.1.6-py3-none-any.whl (134 kB)
Collecting starlette<0.48.0,>=0.40.0
  Using cached starlette-0.47.2-py3-none-any.whl (72 kB)
Collecting pydantic!=1.8,!=1.8.1,!=2.0.0,!=2.0.1,!=2.1.0,<3.0.0,>=1.7.4
  Using cached pydantic-2.11.7-py3-none-any.whl (444 kB)
Collecting typing-extensions>=4.8.0
  Using cached typing_extensions-4.14.1-py3-none-any.whl (43 kB)
Collecting click>=7.0
  Using cached click-8.2.1-py3-none-any.whl (102 kB)
Collecting h11>=0.8
  Using cached h11-0.16.0-py3-none-any.whl (37 kB)
Collecting MarkupSafe>=2.0
  Using cached MarkupSafe-3.0.2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (23 kB)
Collecting annotated-types>=0.6.0
  Using cached https://www.piwheels.org/simple/annotated-types/annotated_types-0.7.0-py3-none-any.whl (13 kB)
Collecting pydantic-core==2.33.2
  Using cached pydantic_core-2.33.2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (1.9 MB)
Collecting typing-inspection>=0.4.0
  Using cached typing_inspection-0.4.1-py3-none-any.whl (14 kB)
Collecting anyio<5,>=3.6.2
  Using cached https://www.piwheels.org/simple/anyio/anyio-4.9.0-py3-none-any.whl (100 kB)
Collecting idna>=2.8
  Using cached https://www.piwheels.org/simple/idna/idna-3.10-py3-none-any.whl (70 kB)
Collecting sniffio>=1.1
  Using cached https://www.piwheels.org/simple/sniffio/sniffio-1.3.1-py3-none-any.whl (10 kB)
Installing collected packages: typing-extensions, sniffio, python-multipart, MarkupSafe, idna, h11, click, annotated-types, uvicorn, typing-inspection, pydantic-core, jinja2, anyio, starlette, pydantic, fastapi
Successfully installed MarkupSafe-3.0.2 annotated-types-0.7.0 anyio-4.9.0 click-8.2.1 fastapi-0.116.1 h11-0.16.0 idna-3.10 jinja2-3.1.6 pydantic-2.11.7 pydantic-core-2.33.2 python-multipart-0.0.20 sniffio-1.3.1 starlette-0.47.2 typing-extensions-4.14.1 typing-inspection-0.4.1 uvicorn-0.35.0
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Collecting supabase
  Using cached supabase-2.17.0-py3-none-any.whl (17 kB)
Collecting boto3
  Using cached boto3-1.39.14-py3-none-any.whl (139 kB)
Collecting python-dotenv
  Using cached python_dotenv-1.1.1-py3-none-any.whl (20 kB)
Collecting requests
  Using cached requests-2.32.4-py3-none-any.whl (64 kB)
Collecting psutil
  Using cached psutil-7.0.0-cp36-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (279 kB)
Collecting pytz
  Using cached https://www.piwheels.org/simple/pytz/pytz-2025.2-py3-none-any.whl (509 kB)
Collecting numpy
  Using cached numpy-2.3.2-cp311-cp311-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl (14.6 MB)
Collecting opencv-python-headless
  Using cached opencv_python_headless-4.12.0.88-cp37-abi3-manylinux2014_aarch64.manylinux_2_17_aarch64.whl (33.1 MB)
Collecting email-validator
  Using cached https://www.piwheels.org/simple/email-validator/email_validator-2.2.0-py3-none-any.whl (33 kB)
Collecting gotrue==2.12.3
  Using cached gotrue-2.12.3-py3-none-any.whl (44 kB)
Collecting httpx<0.29,>=0.26
  Using cached https://www.piwheels.org/simple/httpx/httpx-0.28.1-py3-none-any.whl (73 kB)
Collecting postgrest==1.1.1
  Using cached postgrest-1.1.1-py3-none-any.whl (22 kB)
Collecting realtime==2.6.0
  Using cached realtime-2.6.0-py3-none-any.whl (21 kB)
Collecting storage3==0.12.0
  Using cached storage3-0.12.0-py3-none-any.whl (18 kB)
Collecting supafunc==0.10.1
  Using cached supafunc-0.10.1-py3-none-any.whl (8.0 kB)
Requirement already satisfied: pydantic<3,>=1.10 in ./venv/lib/python3.11/site-packages (from gotrue==2.12.3->supabase) (2.11.7)
Collecting pyjwt<3.0.0,>=2.10.1
  Using cached https://www.piwheels.org/simple/pyjwt/PyJWT-2.10.1-py3-none-any.whl (22 kB)
Collecting deprecation<3.0.0,>=2.1.0
  Using cached https://www.piwheels.org/simple/deprecation/deprecation-2.1.0-py2.py3-none-any.whl (11 kB)
Requirement already satisfied: typing-extensions>=4.14.0 in ./venv/lib/python3.11/site-packages (from realtime==2.6.0->supabase) (4.14.1)
Collecting websockets<16,>=11
  Using cached websockets-15.0.1-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (182 kB)
Collecting python-dateutil<3.0.0,>=2.8.2
  Using cached https://www.piwheels.org/simple/python-dateutil/python_dateutil-2.9.0.post0-py2.py3-none-any.whl (229 kB)
Collecting strenum<0.5.0,>=0.4.15
  Using cached https://www.piwheels.org/simple/strenum/StrEnum-0.4.15-py3-none-any.whl (8.9 kB)
Collecting botocore<1.40.0,>=1.39.14
  Using cached botocore-1.39.14-py3-none-any.whl (13.9 MB)
Collecting jmespath<2.0.0,>=0.7.1
  Using cached https://www.piwheels.org/simple/jmespath/jmespath-1.0.1-py3-none-any.whl (20 kB)
Collecting s3transfer<0.14.0,>=0.13.0
  Using cached s3transfer-0.13.1-py3-none-any.whl (85 kB)
Collecting charset_normalizer<4,>=2
  Using cached charset_normalizer-3.4.2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (142 kB)
Requirement already satisfied: idna<4,>=2.5 in ./venv/lib/python3.11/site-packages (from requests) (3.10)
Collecting urllib3<3,>=1.21.1
  Using cached urllib3-2.5.0-py3-none-any.whl (129 kB)
Collecting certifi>=2017.4.17
  Using cached certifi-2025.7.14-py3-none-any.whl (162 kB)
Collecting numpy
  Using cached numpy-2.2.6-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (14.3 MB)
Collecting dnspython>=2.0.0
  Using cached https://www.piwheels.org/simple/dnspython/dnspython-2.7.0-py3-none-any.whl (313 kB)
Requirement already satisfied: anyio in ./venv/lib/python3.11/site-packages (from httpx<0.29,>=0.26->supabase) (4.9.0)
Collecting httpcore==1.*
  Using cached httpcore-1.0.9-py3-none-any.whl (78 kB)
Requirement already satisfied: h11>=0.16 in ./venv/lib/python3.11/site-packages (from httpcore==1.*->httpx<0.29,>=0.26->supabase) (0.16.0)
Collecting packaging
  Using cached packaging-25.0-py3-none-any.whl (66 kB)
Collecting h2<5,>=3
  Using cached https://www.piwheels.org/simple/h2/h2-4.2.0-py3-none-any.whl (60 kB)
Requirement already satisfied: annotated-types>=0.6.0 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue==2.12.3->supabase) (0.7.0)
Requirement already satisfied: pydantic-core==2.33.2 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue==2.12.3->supabase) (2.33.2)
Requirement already satisfied: typing-inspection>=0.4.0 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.10->gotrue==2.12.3->supabase) (0.4.1)
Collecting six>=1.5
  Using cached https://www.piwheels.org/simple/six/six-1.17.0-py2.py3-none-any.whl (11 kB)
Requirement already satisfied: sniffio>=1.1 in ./venv/lib/python3.11/site-packages (from anyio->httpx<0.29,>=0.26->supabase) (1.3.1)
Collecting hyperframe<7,>=6.1
  Using cached https://www.piwheels.org/simple/hyperframe/hyperframe-6.1.0-py3-none-any.whl (13 kB)
Collecting hpack<5,>=4.1
  Using cached https://www.piwheels.org/simple/hpack/hpack-4.1.0-py3-none-any.whl (34 kB)
Installing collected packages: strenum, pytz, websockets, urllib3, six, python-dotenv, pyjwt, psutil, packaging, numpy, jmespath, hyperframe, hpack, dnspython, charset_normalizer, certifi, requests, python-dateutil, opencv-python-headless, httpcore, h2, email-validator, deprecation, realtime, httpx, botocore, s3transfer, supafunc, storage3, postgrest, gotrue, boto3, supabase
Successfully installed boto3-1.39.14 botocore-1.39.14 certifi-2025.7.14 charset_normalizer-3.4.2 deprecation-2.1.0 dnspython-2.7.0 email-validator-2.2.0 gotrue-2.12.3 h2-4.2.0 hpack-4.1.0 httpcore-1.0.9 httpx-0.28.1 hyperframe-6.1.0 jmespath-1.0.1 numpy-2.2.6 opencv-python-headless-4.12.0.88 packaging-25.0 postgrest-1.1.1 psutil-7.0.0 pyjwt-2.10.1 python-dateutil-2.9.0.post0 python-dotenv-1.1.1 pytz-2025.2 realtime-2.6.0 requests-2.32.4 s3transfer-0.13.1 six-1.17.0 storage3-0.12.0 strenum-0.4.15 supabase-2.17.0 supafunc-0.10.1 urllib3-2.5.0 websockets-15.0.1
ğŸ“· Installing picamera2 in virtual environment...
ğŸ”§ Installing picamera2...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Collecting picamera2
  Using cached picamera2-0.3.30-py3-none-any.whl (121 kB)
Collecting PiDNG
  Using cached pidng-4.0.9-cp311-cp311-linux_aarch64.whl
Collecting av
  Using cached av-15.0.0-cp311-cp311-manylinux_2_28_aarch64.whl (38.2 MB)
Collecting jsonschema
  Using cached jsonschema-4.25.0-py3-none-any.whl (89 kB)
Collecting libarchive-c
  Using cached libarchive_c-5.3-py3-none-any.whl (17 kB)
Requirement already satisfied: numpy in ./venv/lib/python3.11/site-packages (from picamera2) (2.2.6)
Collecting piexif
  Using cached https://www.piwheels.org/simple/piexif/piexif-1.1.3-py2.py3-none-any.whl (20 kB)
Collecting pillow
  Using cached pillow-11.3.0-cp311-cp311-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl (6.0 MB)
Collecting python-prctl
  Using cached python_prctl-1.8.1-cp311-cp311-linux_aarch64.whl
Collecting simplejpeg
  Using cached simplejpeg-1.8.2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (446 kB)
Collecting tqdm
  Using cached https://www.piwheels.org/simple/tqdm/tqdm-4.67.1-py3-none-any.whl (78 kB)
Collecting videodev2
  Using cached videodev2-0.0.4-py3-none-any.whl (49 kB)
Collecting attrs>=22.2.0
  Using cached https://www.piwheels.org/simple/attrs/attrs-25.3.0-py3-none-any.whl (63 kB)
Collecting jsonschema-specifications>=2023.03.6
  Using cached jsonschema_specifications-2025.4.1-py3-none-any.whl (18 kB)
Collecting referencing>=0.28.4
  Using cached https://www.piwheels.org/simple/referencing/referencing-0.36.2-py3-none-any.whl (26 kB)
Collecting rpds-py>=0.7.1
  Using cached rpds_py-0.26.0-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (381 kB)
Requirement already satisfied: typing-extensions>=4.4.0 in ./venv/lib/python3.11/site-packages (from referencing>=0.28.4->jsonschema->picamera2) (4.14.1)
Installing collected packages: python-prctl, libarchive-c, videodev2, tqdm, simplejpeg, rpds-py, pillow, piexif, PiDNG, av, attrs, referencing, jsonschema-specifications, jsonschema, picamera2
Successfully installed PiDNG-4.0.9 attrs-25.3.0 av-15.0.0 jsonschema-4.25.0 jsonschema-specifications-2025.4.1 libarchive-c-5.3 picamera2-0.3.30 piexif-1.1.3 pillow-11.3.0 python-prctl-1.8.1 referencing-0.36.2 rpds-py-0.26.0 simplejpeg-1.8.2 tqdm-4.67.1 videodev2-0.0.4
âš ï¸ picamera2 installation may have failed, but continuing...
âœ… Python dependencies installed successfully
âš™ï¸ Setting up environment configuration...
âœ… .env file already exists (user-managed)
ğŸ” Creating dedicated user and fixing permissions...
âœ… ezrec user already exists
âš™ï¸ Creating systemd service files...
ğŸ”„ Reloading systemd...
ğŸ§ª Testing basic functionality...
âœ… FFmpeg is available
âœ… v4l2-ctl is available
ğŸ“¹ Camera devices:
	/dev/video20
	/dev/video21
	/dev/video22
	/dev/video23
	/dev/video24
	/dev/video25
	/dev/video26
	/dev/video27
	/dev/video28
	/dev/video29
ğŸ Testing Python imports...
ğŸ“· Testing picamera2 in virtual environment...
âŒ Picamera2 import failed in virtual environment
ğŸ”§ Attempting to fix picamera2 installation...
Looking in indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Collecting picamera2
  Using cached picamera2-0.3.30-py3-none-any.whl (121 kB)
Collecting PiDNG
  Using cached pidng-4.0.9-cp311-cp311-linux_aarch64.whl
Collecting av
  Using cached av-15.0.0-cp311-cp311-manylinux_2_28_aarch64.whl (38.2 MB)
Collecting jsonschema
  Using cached jsonschema-4.25.0-py3-none-any.whl (89 kB)
Collecting libarchive-c
  Using cached libarchive_c-5.3-py3-none-any.whl (17 kB)
Collecting numpy
  Using cached numpy-2.3.2-cp311-cp311-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl (14.6 MB)
Collecting piexif
  Using cached https://www.piwheels.org/simple/piexif/piexif-1.1.3-py2.py3-none-any.whl (20 kB)
Collecting pillow
  Using cached pillow-11.3.0-cp311-cp311-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl (6.0 MB)
Collecting python-prctl
  Using cached python_prctl-1.8.1-cp311-cp311-linux_aarch64.whl
Collecting simplejpeg
  Using cached simplejpeg-1.8.2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (446 kB)
Collecting tqdm
  Using cached https://www.piwheels.org/simple/tqdm/tqdm-4.67.1-py3-none-any.whl (78 kB)
Collecting videodev2
  Using cached videodev2-0.0.4-py3-none-any.whl (49 kB)
Collecting attrs>=22.2.0
  Using cached https://www.piwheels.org/simple/attrs/attrs-25.3.0-py3-none-any.whl (63 kB)
Collecting jsonschema-specifications>=2023.03.6
  Using cached jsonschema_specifications-2025.4.1-py3-none-any.whl (18 kB)
Collecting referencing>=0.28.4
  Using cached https://www.piwheels.org/simple/referencing/referencing-0.36.2-py3-none-any.whl (26 kB)
Collecting rpds-py>=0.7.1
  Using cached rpds_py-0.26.0-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl (381 kB)
Collecting typing-extensions>=4.4.0
  Using cached typing_extensions-4.14.1-py3-none-any.whl (43 kB)
Installing collected packages: python-prctl, libarchive-c, videodev2, typing-extensions, tqdm, rpds-py, pillow, piexif, numpy, av, attrs, simplejpeg, referencing, PiDNG, jsonschema-specifications, jsonschema, picamera2
  Attempting uninstall: python-prctl
    Found existing installation: python-prctl 1.8.1
    Uninstalling python-prctl-1.8.1:
      Successfully uninstalled python-prctl-1.8.1
  Attempting uninstall: libarchive-c
    Found existing installation: libarchive-c 5.3
    Uninstalling libarchive-c-5.3:
      Successfully uninstalled libarchive-c-5.3
  Attempting uninstall: videodev2
    Found existing installation: videodev2 0.0.4
    Uninstalling videodev2-0.0.4:
      Successfully uninstalled videodev2-0.0.4
  Attempting uninstall: typing-extensions
    Found existing installation: typing_extensions 4.14.1
    Uninstalling typing_extensions-4.14.1:
      Successfully uninstalled typing_extensions-4.14.1
  Attempting uninstall: tqdm
    Found existing installation: tqdm 4.67.1
    Uninstalling tqdm-4.67.1:
      Successfully uninstalled tqdm-4.67.1
  Attempting uninstall: rpds-py
    Found existing installation: rpds-py 0.26.0
    Uninstalling rpds-py-0.26.0:
      Successfully uninstalled rpds-py-0.26.0
  Attempting uninstall: pillow
    Found existing installation: pillow 11.3.0
    Uninstalling pillow-11.3.0:
      Successfully uninstalled pillow-11.3.0
  Attempting uninstall: piexif
    Found existing installation: piexif 1.1.3
    Uninstalling piexif-1.1.3:
      Successfully uninstalled piexif-1.1.3
  Attempting uninstall: numpy
    Found existing installation: numpy 2.2.6
    Uninstalling numpy-2.2.6:
      Successfully uninstalled numpy-2.2.6
  Attempting uninstall: av
    Found existing installation: av 15.0.0
    Uninstalling av-15.0.0:
      Successfully uninstalled av-15.0.0
  Attempting uninstall: attrs
    Found existing installation: attrs 25.3.0
    Uninstalling attrs-25.3.0:
      Successfully uninstalled attrs-25.3.0
  Attempting uninstall: simplejpeg
    Found existing installation: simplejpeg 1.8.2
    Uninstalling simplejpeg-1.8.2:
      Successfully uninstalled simplejpeg-1.8.2
  Attempting uninstall: referencing
    Found existing installation: referencing 0.36.2
    Uninstalling referencing-0.36.2:
      Successfully uninstalled referencing-0.36.2
  Attempting uninstall: PiDNG
    Found existing installation: pidng 4.0.9
    Uninstalling pidng-4.0.9:
      Successfully uninstalled pidng-4.0.9
  Attempting uninstall: jsonschema-specifications
    Found existing installation: jsonschema-specifications 2025.4.1
    Uninstalling jsonschema-specifications-2025.4.1:
      Successfully uninstalled jsonschema-specifications-2025.4.1
  Attempting uninstall: jsonschema
    Found existing installation: jsonschema 4.25.0
    Uninstalling jsonschema-4.25.0:
      Successfully uninstalled jsonschema-4.25.0
  Attempting uninstall: picamera2
    Found existing installation: picamera2 0.3.30
    Uninstalling picamera2-0.3.30:
      Successfully uninstalled picamera2-0.3.30
Successfully installed PiDNG-4.0.9 attrs-25.3.0 av-15.0.0 jsonschema-4.25.0 jsonschema-specifications-2025.4.1 libarchive-c-5.3 numpy-2.3.2 picamera2-0.3.30 piexif-1.1.3 pillow-11.3.0 python-prctl-1.8.1 referencing-0.36.2 rpds-py-0.26.0 simplejpeg-1.8.2 tqdm-4.67.1 typing-extensions-4.14.1 videodev2-0.0.4
âš ï¸ Picamera2 still not working - this may cause recording issues
ğŸ”§ Testing other critical packages...
âœ… fastapi is working
âœ… supabase is working
âœ… psutil is working
âœ… boto3 is working
â° Setting up cron jobs...
ğŸš€ Enabling and starting services...
ğŸ“¹ Adding ezrec user to video group for camera access...
ğŸ”„ Resetting failed services...
ğŸ” Validating critical files...
âœ… Found: /opt/ezrec-backend/backend/dual_recorder.py
âœ… Found: /opt/ezrec-backend/backend/video_worker.py
âŒ Critical file missing: /opt/ezrec-backend/backend/system_status.py
âœ… Found: /opt/ezrec-backend/api/api_server.py
âœ… Found: /opt/ezrec-backend/backend/enhanced_merge.py
âš ï¸ Some critical files are missing. Deployment may fail.
Continuing anyway, but check the file paths above.
ğŸ”„ Restarting all services...
ğŸ“Š Checking service status...
--- dual_recorder.service ---
â— dual_recorder.service - EZREC Dual Camera Recorder
     Loaded: loaded (/etc/systemd/system/dual_recorder.service; enabled; preset: enabled)
     Active: active (running) since Sat 2025-07-26 21:36:34 EDT; 57ms ago
   Main PID: 328335 (python3)
      Tasks: 1 (limit: 9577)
        CPU: 52ms
     CGroup: /system.slice/dual_recorder.service
             â””â”€328335 /opt/ezrec-backend/api/venv/bin/python3 /opt/ezrec-backend/backend/dual_recorder.py

Jul 26 21:36:34 raspberrypi systemd[1]: Started dual_recorder.service - EZREC Dual Camera Recorder.
âœ… dual_recorder.service status retrieved successfully

--- video_worker.service ---
â— video_worker.service - EZREC Video Processor
     Loaded: loaded (/etc/systemd/system/video_worker.service; enabled; preset: enabled)
     Active: active (running) since Sat 2025-07-26 21:36:34 EDT; 78ms ago
   Main PID: 328336 (python3)
      Tasks: 1 (limit: 9577)
        CPU: 66ms
     CGroup: /system.slice/video_worker.service
             â””â”€328336 /opt/ezrec-backend/api/venv/bin/python3 /opt/ezrec-backend/backend/video_worker.py

Jul 26 21:36:34 raspberrypi systemd[1]: Started video_worker.service - EZREC Video Processor.
âœ… video_worker.service status retrieved successfully

--- ezrec-api.service ---
â— ezrec-api.service - EZREC FastAPI Backend
     Loaded: loaded (/etc/systemd/system/ezrec-api.service; enabled; preset: enabled)
     Active: active (running) since Sat 2025-07-26 21:36:34 EDT; 98ms ago
   Main PID: 328337 (uvicorn)
      Tasks: 1 (limit: 9577)
        CPU: 80ms
     CGroup: /system.slice/ezrec-api.service
             â””â”€328337 /opt/ezrec-backend/api/venv/bin/python3 /opt/ezrec-backend/api/venv/bin/uvicorn api_server:app --host 0.0.0.0 --port 8000

Jul 26 21:36:34 raspberrypi systemd[1]: Started ezrec-api.service - EZREC FastAPI Backend.
âœ… ezrec-api.service status retrieved successfully

--- system_status.service ---
â— system_status.service - EZREC System Status Monitor
     Loaded: loaded (/etc/systemd/system/system_status.service; enabled; preset: enabled)
     Active: activating (auto-restart) (Result: exit-code) since Sat 2025-07-26 21:36:34 EDT; 81ms ago
    Process: 328338 ExecStart=/opt/ezrec-backend/api/venv/bin/python3 /opt/ezrec-backend/backend/system_status.py (code=exited, status=2)
   Main PID: 328338 (code=exited, status=2)
        CPU: 30ms
âš ï¸ Could not retrieve system_status.service status (use: sudo journalctl -u system_status.service)

ğŸ” Validating all services are running...
âœ… dual_recorder.service is running
âœ… video_worker.service is running
âœ… ezrec-api.service is running
âŒ system_status.service is not running
âš ï¸ Some services failed to start. Check the status above.
ğŸŒ Testing API endpoint...
âœ… API is responding
"degraded"
[
  "Service system_status is activating"
]
ğŸ” Running system readiness test...
ğŸ” Running system readiness tests...
==================================================

ğŸ“‹ Environment Variables:
âŒ Environment: Missing ['SUPABASE_URL', 'SUPABASE_KEY', 'USER_ID', 'CAMERA_ID']

ğŸ“‹ Directories:
âœ… Directories: All required directories exist

ğŸ“‹ FFmpeg:
âŒ FFmpeg: Failed

ğŸ“‹ FFprobe:
âŒ FFprobe: Failed

ğŸ“‹ v4l2-ctl:
âœ… v4l2-ctl: Available

ğŸ“‹ Camera Devices:
âœ… Camera devices: 33 found

ğŸ“‹ API Health:
âœ… API health: degraded
âš ï¸ Warnings: 1 issues

ğŸ“‹ System Services:
âœ… Service dual_recorder: Active
âœ… Service video_worker: Active
âœ… Service ezrec-api: Active

==================================================
ğŸ“Š TEST SUMMARY:
  âŒ FAIL Environment Variables
  âœ… PASS Directories
  âŒ FAIL FFmpeg
  âŒ FAIL FFprobe
  âœ… PASS v4l2-ctl
  âœ… PASS Camera Devices
  âŒ FAIL API Health
  âœ… PASS System Services

ğŸ¯ Overall: 4/8 tests passed
âš ï¸ System has issues that need to be fixed before recording.
âš ï¸ System readiness test failed - check the output above
ğŸ” Verifying system services...
ğŸ“Š Service Status Summary:
==========================
âœ… dual_recorder.service: ACTIVE
âœ… video_worker.service: ACTIVE
âœ… ezrec-api.service: ACTIVE
âŒ system_status.service: INACTIVE

ğŸŒ API Connectivity Test:
âœ… API is reachable at http://localhost:8000
ğŸ“Š API Health Details:
"degraded"
[
  "Service system_status is activating"
]

ğŸ“ Critical Directory Check:
âœ… /opt/ezrec-backend/logs: EXISTS
âœ… /opt/ezrec-backend/recordings: EXISTS
âœ… /opt/ezrec-backend/api: EXISTS

ğŸ‰ EZREC Backend Deployment Completed!
======================================
ğŸ“… Deployment Time: 2025-07-26 21:36:46
ğŸ‘¤ Service User: ezrec
ğŸ” Security: Hardened systemd services with minimal privileges

ğŸ“‹ Next Steps:
1. Create and configure /opt/ezrec-backend/.env with your credentials
2. Create a test booking to verify everything works
3. Monitor logs: sudo journalctl -u dual_recorder.service -f

ğŸ“ Important Directories:
   - Logs: /opt/ezrec-backend/logs
   - Recordings: /opt/ezrec-backend/recordings
   - API: /opt/ezrec-backend/api

ğŸ”§ Useful Commands:
   - Check status: sudo systemctl status dual_recorder.service
   - View logs: sudo journalctl -u dual_recorder.service -f
   - Restart services: sudo systemctl restart dual_recorder.service
   - Test system: sudo python3 test_system_readiness.py

ğŸ“ Tip: To log this deployment, run:
   ./deployment.sh | tee ezrec_deploy_$(date +%Y%m%d_%H%M%S).log

âœ… Deployment completed successfully!
